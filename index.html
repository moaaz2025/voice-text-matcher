<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Øµ Ø¨Ø§Ù„ØµÙˆØª</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <style>
    body { font-family: Arial; text-align: center; padding: 20px; background: #f0f0f0; direction: rtl; }
    #canvas { display: none; }
    #imageDisplay { width: 100%; max-width: 600px; margin-top: 15px; }
    #chatBox {
      background: white;
      width: 90%;
      max-width: 600px;
      margin: auto;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      text-align: right;
    }
    #chatBox div {
      margin: 10px 0;
    }
    .user { color: blue; font-weight: bold; }
    .sys { color: green; }
    button { padding: 10px 20px; font-size: 16px; margin-top: 10px; cursor: pointer; }
    input { margin-bottom: 15px; }
    mark { background: yellow; }
    .highlight { text-decoration: underline; color: red; font-weight: bold; }
  </style>
</head>
<body>

  <h2>ğŸ–¼ï¸ ØªØ­Ø¯Ø« Ø¨Ù…Ø§ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©</h2>

  <input type="file" id="imageInput" accept="image/*"><br>
  <img id="imageDisplay" src="" alt="ØµÙˆØ±Ø© Ø§Ù„Ù†Øµ" />
  <button onclick="startListening()">ğŸ™ï¸ Ø§Ø¶ØºØ· ÙˆØªØ­Ø¯Ø«</button>

  <div id="chatBox">
    <div class="sys">â¬†ï¸ Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†Øµ Ø¹Ø±Ø¨ÙŠ</div>
  </div>

  <audio id="beep" src="https://www.soundjay.com/buttons/sounds/beep-07.mp3"></audio>

  <script>
    const chatBox = document.getElementById('chatBox');
    const imageInput = document.getElementById('imageInput');
    const imageDisplay = document.getElementById('imageDisplay');
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    let extractedText = '';

    function addMessage(text, sender = 'sys') {
      const div = document.createElement('div');
      div.className = sender;
      div.innerHTML = text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    imageInput.addEventListener('change', async function () {
      const file = this.files[0];
      const img = new Image();
      img.onload = async () => {
        imageDisplay.src = img.src; // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);

        addMessage("ğŸ“„ Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©...", "sys");

        const result = await Tesseract.recognize(img, 'ara', {
          logger: m => console.log(m)
        });
        extractedText = result.data.text.trim();
        addMessage("ğŸ“œ Ø§Ù„Ù†Øµ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©:<br>" + extractedText, "sys");
      };
      img.src = URL.createObjectURL(file);
    });

    function startListening() {
      if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª!');
        return;
      }

      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'ar-EG';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      addMessage("ğŸ™ï¸ Ø§Ø³ØªÙ…Ø¹ Ø§Ù„Ø¢Ù†...", "sys");
      recognition.start();

      recognition.onresult = function (event) {
        const spoken = event.results[0][0].transcript.trim();
        addMessage("ğŸ—£ï¸ Ø£Ù†Øª Ù‚Ù„Øª: " + spoken, "user");

        const loweredSpoken = spoken.toLowerCase();
        const loweredText = extractedText.toLowerCase();

        if (loweredText.includes(loweredSpoken)) {
          // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ø§Ù… Ø§Ù„Ø°ÙŠ Ù‚ÙŠÙ„
          const highlighted = extractedText.replace(
            new RegExp(`(${spoken})`, 'gi'),
            '<span class="highlight">$1</span>'
          );
          addMessage("âœ… Ø§Ù„ÙƒÙ„Ø§Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙˆØ±Ø©!", "sys");
          addMessage("ğŸ” Ø§Ù„Ù†Øµ Ù…Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ¯:<br>" + highlighted, "sys");
        } else {
          document.getElementById('beep').play();
          addMessage("âŒ Ø§Ù„ÙƒÙ„Ø§Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©!", "sys");
        }
      };

      recognition.onerror = function (event) {
        addMessage("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª: " + event.error, "sys");
      };
    }
  </script>

</body>
</html>
